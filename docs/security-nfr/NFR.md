# NFR по безопасности для Idea Catalog API

## О чём документ
Этот список фиксирует минимально необходимую защиту сервиса идей. Большая часть требований уже знакома команде, но я решил переформулировать их так, чтобы выдержать живой тон и не терять рабочую точность. Списки наверняка будут дорабатываться, однако сейчас они отражают то, что мы готовы проверять регулярно. Был момент, когда я хотел оставить сухую таблицу без пояснений — нет, так было бы тяжело читать.

Коротко.

## Как читать таблицу
Каждая строка — это конкретное требование с проверяемой метрикой. В колонке «Проверка» указаны источники, где команда подтверждает соблюдение порога: автотесты, nightly-job или ручной чек-лист. Если компонент не совпадает с текущей зоной ответственности, отмечаю это отдельно, чтобы не потерять задачу на стыке команд. Иногда я сомневался, стоит ли дублировать очевидные вещи вроде Pydantic, но опыт ревью показал: лучше проговорить явное.

## Требования

| ID     | Название                               | Описание                                                                                          | Метрика/Порог                                         | Проверка (чем/где)                                               | Компонент       | Приоритет |
|--------|----------------------------------------|---------------------------------------------------------------------------------------------------|-------------------------------------------------------|------------------------------------------------------------------|-----------------|-----------|
| NFR-01 | Контроль админ-доступа                 | Любое административное действие выполняется только с JWT, подписанным RS256, сроком до 60 минут. | 100% защищённых эндпойнтов требуют JWT; TTL токена ≤ 3600 c | Контрактные тесты `tests/security/test_admin_access.py` + анализ переменных окружения в CI | auth            | High      |
| NFR-02 | Строгая валидация входных данных       | Мы пропускаем лишь те payload, что проходят Pydantic и дополнительные фильтры на бизнес-уровне.   | 100% POST/PATCH отклоняют данные вне схемы             | `pytest -q` (включая `tests/test_ideas.py`) + `ruff` для стат.контроля | api             | High      |
| NFR-03 | Ограничение частоты создания идей      | Пользователь не может отправить больше 100 успешных POST `/ideas` за одну минуту.                 | ≤ 100 успешных POST `/ideas` на токен за 60 c          | Нагрузочный тест k6 `scripts/loadtest/ideas-rate-limit.js` в nightly pipeline | api-gateway     | Medium    |
| NFR-04 | Блокировка повторных оценок            | Один пользователь оставляет не более одной активной оценки на конкретную идею.                    | ≤ 1 активная оценка на пользователя и идею             | Интеграционный тест `tests/security/test_eval_dedup.py` (Sprint S2) | core-service    | Medium    |
| NFR-05 | Логирование подозрительных действий    | Сервер фиксирует почти все ошибки 401/403 в отдельном security-логе с маркерами.                  | ≥ 95% событий 401/403 попадают в `security.log`        | Скрипт `scripts/check_security_logs.py` + ежеспринтовая выборка  | observability   | Medium    |
| NFR-06 | Закрытие уязвимостей зависимостей      | Уязвимости уровня High/Critical устраняем в течение семи дней после обнаружения.                  | SLA устранения ≤ 7 дней                               | Еженедельный запуск `pip-audit` + обязательное GitHub Issue с дедлайном | build-pipeline  | High      |
| NFR-07 | Управление секретами                   | Секреты лежат только во Vault/ENV, а их TTL ограничен тридцатью днями.                            | TTL каждого секрета ≤ 30 дней                         | Скрипт `scripts/secrets_ttl.py` в CI + отчёт Vault               | platform        | Medium    |
| NFR-08 | Шифрование резервных копий             | Все бэкапы приложения и базы шифруются алгоритмом AES-256, ключ хранится в KMS.                   | 100% бэкапов зашифрованы AES-256, ключ в KMS           | Отчёт KMS + контрольный пункт релизного чек-листа                | infra           | Low       |

## Что дальше
Эти требования попадут в дорожную карту релизов. Однако часть метрик ещё нужно автоматизировать: сейчас, например, скрипт проверки TTL секретов только в планах. Помечаю это, чтобы не забыть при запуске следующего спринта.

## Приложенные доказательства
- NFR-02: свежий прогон `pytest -q` с негативными кейсами — см. `docs/security-nfr/evidence/pytest-20251006-204447.log`.

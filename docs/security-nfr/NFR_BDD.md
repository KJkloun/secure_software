# BDD-сценарии для Security NFR

## Как пользоваться
Набор сценариев помогает проверять ключевые требования из `NFR.md` через Given/When/Then. Я переписал формулировки чуть свободнее, чтобы ими было проще делиться с QA и разработчиками. Сначала занёс шаги в таблицу, но тут же понял, что Gherkin читается быстрее — вернулся к привычному формату. В прошлый раз мы путались в названиях шагов, поэтому сейчас каждый сценарий держит один конкретный порог и конкретный артефакт проверки. Однако, если появятся новые ограничения, набор легко расширить. Помню, как на демо мы вручную повторяли шаги rate limiting — это была скучная сессия.

Готово.

## Сценарии

Feature: Контроль доступа к административным маршрутам
  Scenario: Администратор читает журнал аудита с валидным токеном
    Given stage окружение использует JWT с подписью RS256 и сроком жизни до 60 минут
    And у меня есть действительный административный токен
    When я отправляю GET запрос на /admin/audit-events с этим токеном
    Then ответ имеет статус 200
    And тело ответа показывает события без персональных данных

  Scenario: Запрос без токена возвращает ошибку 401
    Given stage окружение использует JWT с подписью RS256 и сроком жизни до 60 минут
    When я отправляю GET запрос на /admin/audit-events без заголовка Authorization
    Then ответ имеет статус 401
    And тело ошибки содержит код "unauthorized"

Feature: Rate limiting для создания идей
  Scenario: Превышение лимита приводит к 429
    Given включён лимит 100 успешных POST /ideas на одного пользователя в минуту
    And пользователь уже создал 100 идей в последнюю минуту
    When пользователь отправляет ещё один POST запрос на /ideas
    Then ответ имеет статус 429
    And тело ошибки содержит код "rate_limit_exceeded"

Feature: Контроль SCA отчётов
  Scenario: Просроченная уязвимость ломает пайплайн
    Given зависимость отмечена как High severity и исправление задерживается больше семи дней
    When nightly SCA job выполняет `pip-audit`
    Then отчёт содержит запись о нарушенном SLA исправления
    And пайплайн CI завершается со статусом failed

Feature: Audit log для повторных ошибок авторизации
  Scenario: Три подряд ошибки авторизации попадают в security.log
    Given включено централизованное логирование в файл security.log
    And атакующий отправил два запроса с неверными токенами в последние 30 секунд
    When атакующий отправляет ещё один запрос с неверным токеном
    Then ответ имеет статус 401
    And security.log получает запись с уровнем WARN и идентификатором клиента

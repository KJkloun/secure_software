# ADR-002: Secure Attachment Handling
Дата: 2025-02-20
Статус: Accepted

## Context
Команда продукта добавляет обмен иллюстрациями к идеям. Поток попадает в контур F1 (POST ресурсы в API), и без доп.контролей мы получим риск R1: path traversal, загрузка исполняемых файлов либо DoS чрезмерным объёмом. Требование NFR-02 обязывает фильтровать все пользовательские данные, включая бинарные вложения.

## Decision
Реализовали `AttachmentStorage`: сохраняем в изолированную директорию (по умолчанию `var/uploads`, в тестах — tmp), имя файла — UUID, расширение выводим из magic bytes. Допустимые типы: `image/png`, `image/jpeg`. Лимит размера — 5 МБ. Перед записью проверяем: сигнатуру, финальный байт для JPEG, отсутствие симлинков на пути и что `resolve()` остаётся в корне хранилища. При нарушении — `ApiProblem` с `attachment_*` кодами.

## Alternatives
- **Проверять только MIME из заголовка** — ненадёжно (можно подменить).
- **Довериться S3-прокси** — усложнит деплой и не решит локальные тесты; выбор отложен до миграции в облако.
- **Отказаться от локального хранения** — против бизнес-задачи; внешнее CDN требует отдельного ADR.

## Security impact
Контроль закрывает часть риска R1 (Tampering) и снижает вероятность LFI/RCE через вложения. Для STRIDE это вводит барьер на Tampering и Elevation попытки через бинарь. Наличие фиксированного лимита + сигнатур защищает и производительность (нет гигабайтных файлов) и целостность.

## Consequences
Плюсы: защищённая запись без внешних зависимостей, понятные коды ошибок. Минусы: ограничение до PNG/JPEG, рост latency на чтение всего файла в память (при 5 МБ приемлемо). В будущем понадобится миграция на потоковую обработку для больших файлов.

## Rollout plan
- Контракт покрытия — тесты `tests/test_attachments.py`.
- Добавим async-обработку и хранение в объектное хранилище в P06 (feature flag `attachments.object-storage`).
- В observability добавим счётчик отказов по кодам `attachment_*` в следующей итерации.

## Links
- NFR-02
- F1, R1
- tests/test_attachments.py::test_upload_accepts_png_and_records_attachment
- tests/test_attachments.py::test_rejects_large_attachment
- tests/test_attachments.py::test_rejects_unknown_signature

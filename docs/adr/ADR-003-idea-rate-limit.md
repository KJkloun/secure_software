# ADR-003: Idea Creation Rate Limit
Дата: 2025-02-20
Статус: Accepted

## Context
Нагрузка от ботов или некорректных интеграций на POST `/ideas` способна обрушить in-memory стор или заддосить API (STRIDE F1/F2, риск R4). NFR-03 требует лимитов на частоту запросов. Пока API фронтов запускается без gateway rate limiting, поэтому нужен внутренний guard.

## Decision
Добавили in-memory `RateLimiter` (окно 60 сек) на уровне FastAPI. Ключ — `X-Client-Id`, иначе IP. Лимит по умолчанию `100 req/min`, значение можно настроить через `IDEA_RATE_LIMIT_PER_MINUTE` без перезагрузки. При превышении возвращаем `ApiProblem` с кодом `too_many_requests`, status 429 и меткой `limit_per_minute`. Состояние сбрасываем в тестах/health-checkах.

## Alternatives
- **Делегировать gateway** — пока отсутствует единый ingress; переносим после унификации инфраструктуры.
- **Leaky bucket в Redis** — даёт горизонтальное масштабирование, но требует отдельного сервиса и DevOps-усилий, что не вписывается в P05.
- **Лимитировать по JWT subject** — потребует обязательной аутентификации; сейчас в курсовом проекте публичные POST без auth.

## Security impact
Сдерживает DoS и снижает вероятность эксплуатаций R4, пока нет внешних лимитов. В STRIDE закрывает направление Denial of Service. Дополнительно в ответе отдаём `correlation_id`, что позволяет сопоставить инцидент.

## Consequences
Плюсы: лёгкая реализация, возможность настройки через env. Минусы: состояние в памяти → придётся заменить при горизонтальном масштабировании, а также требуется передавать `X-Client-Id` сценариями без реального IP.

## Rollout plan
- Начиная с этого коммита, все клиенты обязаны посылать `X-Client-Id`; фронт добавит его в P05 PR.
- Для прод-окружения создадим Terraform-параметр, который пишет лимит в переменную окружения.
- Дальнейшая эволюция — вынос логики на API Gateway и хранение счётчиков в Redis (запланировано в Q2).

## Links
- NFR-03
- F1, R4
- tests/test_errors.py::test_rate_limit_blocks_excessive_requests

# ADR-001: RFC7807 Problem Details
Дата: 2025-02-20
Статус: Accepted

## Context
Инциденты из P04 показывали, что разношёрстные JSON-ошибки усложняют расследование и создают риск утечки внутренних сообщений (STRIDE F3, риск R9). Клиентам приходилось разбирать поле `error`, отсутствовал `correlation_id`, и логи не совпадали с ответом клиента. Нам нужен стандартный, предсказуемый формат, согласованный с NFR-02, чтобы маскировать детали и упростить трассировку.

## Decision
Вводим единый обработчик `ApiProblem`, который формирует ответы по RFC 7807: `type`, `title`, `status`, `detail`, `code`, `correlation_id` + заголовок `X-Correlation-Id`. Все доменные, HTTP и валидационные исключения приводим к `ApiProblem`. Детали ограничены безопасным текстом, расширенные данные (например, список полей-нарушителей) передаём через whitelisted extras.

## Alternatives
- **Сохранить старую JSON-обёртку** — отклонено: неудобна для межкомандного обмена и не покрывает требования NFR-02.
- **Использовать собственный protobuf/код ошибки** — избыточно для публичного REST API; потребует обвязку на клиентах.
- **Передавать stack trace в non-prod** — повышает риск утечки, нарушает принцип минимально необходимой информации.

## Security impact
Решение нивелирует риск R9: скрываем внутренние сообщения и предоставляем traceable `correlation_id`, чтобы SOC сопоставил запрос и лог. Для F3 это снижает вероятность Information Disclosure и упрощает алерты на редко встречающиеся `type`.

## Consequences
Плюсы: стандартизованный контракт, лучшая DX для фронтенда и поддержки. Минусы: требуется обновление всех тестов и клиентов, плюс дополнительная генерация UUID на каждый инцидент (минимальная нагрузка).

## Rollout plan
- Обновлены автоматические тесты (P05).
- В рамках P06 синхронизируем клиентов (frontend/sdk) по новому контракту.
- Добавим корелляцию с security-логами (NFR-05) в ближайший спринт, используя `correlation_id`.

## Links
- NFR-02
- F3, R9
- tests/test_errors.py::test_idea_not_found_returns_problem_details
- tests/test_errors.py::test_invalid_status_change_uses_problem_details

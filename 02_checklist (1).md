# P06 — Чек-лист сдачи и критерии

## C1. Исправление уязвимости — ★ 1
- Устранил DoS-вектор: ранее `/ideas/{id}/attachments` сохранял файл до проверки идеи, поэтому злоумышленник мог засорять диск, отправляя большие вложения на несуществующие `id`. Теперь наличие идеи проверяется перед чтением файла (`app/main.py:476-503`), а при сбое добавления вложения файл немедленно удаляется (`app/security.py:83-125`).
- Добавлен метод `AttachmentStorage.delete`, чтобы гарантированно убирать артефакты после отменённых операций (`app/security.py:83-98`).

## C2. Тесты (вкл. негативные) — ★ 1
- Расширены негативные сценарии: новые тесты `test_rejects_missing_idea_without_writing_file` и `test_cleanup_happens_when_storage_add_fails` подтверждают, что сервис не создаёт артефакты при ошибках (`tests/test_attachments.py:101-135`).
- Полный набор из 12 тестов выполняется локально командой `python3 -m pytest -q` (`README.md:26-29`, запуск см. раздел «Тесты» в PR описании).

## C3. Валидация/ошибки/логирование — ★ 1
- Валидация входных данных усилена: `IdeaStorage.ensure_exists` выдаёт RFC7807-ответ 404 до чтения потока (`app/main.py:317-319`). Это защищает от лишней нагрузки и соблюдает формат ошибок (`ApiProblem`).
- Обновлённая ветка обработки ошибок гарантирует, что при любой проблеме загрузки клиент получает корректно классифицированную ошибку (429/413/415/404/503) и безопасный `correlation_id` (`app/main.py:476-503`).

## C4. Линт/формат/quality gate — ★ 1
- Локальный ритуал перед PR (ruff, black, isort, pytest, pre-commit) задокументирован и выполнен (`README.md:14-30`).
- CI блокирует merge при отклонениях: workflow запускает линтеры, форматтеры, тесты и pre-commit, а также запрещает коммиты в `main` и неверные имена веток (`.github/workflows/ci.yml:18-56`).

## C5. Интеграция в модуль проекта — ★ 1
- Фикс встроен в рабочий модуль FastAPI: изменения затрагивают `AttachmentStorage`, API-эндпойнт и связанные тесты (`app/main.py:268-503`, `app/security.py:83-125`, `tests/test_attachments.py:27-135`).
- Ветвление соответствует политике `p02/...` (`docs/branching.md:13-31`). Для переноса проекта в новую организацию добавлен регламент `docs/repo-migration.md`, охватывающий зеркалирование всех веток и восстановление защиты.

## Что сдаём в PR
- Diff кода + отчёт `python3 -m pytest -q` (12/12 зелёных).
- Обновлённый чек-лист (`02_checklist (1).md`) и регламент миграции (`docs/repo-migration.md`).
- CI Workflow `CI` зелёный; шаблон PR заполняется по `.github/pull_request_template.md`.
